import{r as g,c as L,P as U,b as o,e as l,l as p,g as x,u as b,b1 as R,t as y,i as F,av as J,v as O,x as M,F as B,y as C,aj as V,a0 as H,a6 as K,o as n,b2 as Q}from"./vendor-jx2CZFIM.js";import{_ as X,u as Y}from"./app-B7lCvxts.js";const Z={class:"image-upload-container"},ee={class:"text-xs text-gray-400 mt-2"},te={key:0,class:"mt-4"},se={class:"flex items-center justify-between mb-3"},ae={class:"text-sm font-medium text-gray-700"},re={class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"},le={class:"aspect-square rounded-lg overflow-hidden border border-gray-200"},oe=["src","alt","onError"],ne={class:"absolute top-1 right-1 flex space-x-1"},ue=["onClick"],ie={key:0,class:"absolute bottom-1 left-1 bg-[#0099cc] text-white text-xs px-2 py-1 rounded"},de={key:1,class:"absolute top-1 left-1 bg-green-500 text-white text-xs px-2 py-1 rounded",title:"Image existante"},ce={key:2,class:"absolute inset-0 bg-black/50 flex items-center justify-center rounded-lg"},pe={key:3,class:"absolute inset-0 bg-red-500/80 flex items-center justify-center rounded-lg"},ge={class:"text-white text-xs text-center p-2"},me={key:1,class:"mt-3"},ve={key:2,class:"mt-4"},fe={class:"flex items-center justify-between text-sm text-gray-600 mb-1"},he={class:"w-full bg-gray-200 rounded-full h-2"},xe={__name:"ImageUpload",props:{modelValue:{type:Array,default:()=>[]},uploadEndpoint:{type:String,default:"/products/images"},maxFiles:{type:Number,default:10},maxSizeMB:{type:Number,default:5},helpText:{type:String,default:null},autoUpload:{type:Boolean,default:!0},existingImages:{type:Array,default:()=>[]}},emits:["update:modelValue","success","error","progress","remove-existing"],setup(_,{expose:A,emit:P}){const i=_,m=P,{post:N}=Y(),$=g(null),r=g([]),d=g([]),h=g(!1),v=g(!1),f=g(0),k=L(()=>i.maxFiles-r.value.length);let w=!1,I=!1;U(()=>i.modelValue,(t,e)=>{if(I)return;const s=e?e.sort().join(","):"",a=t?t.sort().join(","):"";s!==a&&(w=!0,t&&t.length>0?r.value.filter(c=>c.uploaded).map(c=>c.url).sort().join(",")!==a&&(r.value=t.map(c=>({preview:c,url:c,uploaded:!0}))):(!t||t.length===0)&&(r.value=[]),w=!1)},{immediate:!0}),U(()=>i.existingImages,t=>{if(t&&t.length>0){const e=t.map(a=>({preview:a,url:a,uploaded:!0,existing:!0})),s=r.value.filter(a=>!a.existing);r.value=[...e,...s]}},{immediate:!0}),U(r,t=>{if(w)return;I=!0;const e=t.filter(s=>s.uploaded&&s.url).map(s=>s.url);m("update:modelValue",e),Q(()=>{I=!1})},{deep:!0});const z=()=>{$.value?.click()},T=t=>{const e=Array.from(t.target.files);D(e),t.target.value=""},G=t=>{t.preventDefault(),h.value=!1;const e=Array.from(t.dataTransfer.files).filter(s=>s.type.startsWith("image/"));D(e)},D=t=>{d.value=[],t.length>k.value&&(d.value.push(`Maximum ${i.maxFiles} images autorisées. ${k.value} emplacements restants.`),t=t.slice(0,k.value)),t.forEach(e=>{if(e.size>i.maxSizeMB*1024*1024){d.value.push(`${e.name} est trop volumineux (max ${i.maxSizeMB}MB)`);return}if(!e.type.startsWith("image/")){d.value.push(`${e.name} n'est pas une image valide`);return}const s=new FileReader;s.onload=a=>{const u={file:e,preview:a.target.result,name:e.name,size:e.size,uploading:!1,uploaded:!1,error:!1,url:null};r.value.push(u),i.autoUpload&&S(r.value.length-1)},s.readAsDataURL(e)})},S=async t=>{const e=r.value[t];if(!(!e||e.uploaded||e.uploading)){console.log("Starting image upload:",{index:t,fileName:e.name,fileSize:e.size}),e.uploading=!0,e.error=!1,v.value=!0;try{const s=new FormData;s.append("image",e.file),s.append("index",t);const a=await N(i.uploadEndpoint,s,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:u=>{const c=Math.round(u.loaded*100/u.total);j(),m("progress",{index:t,progress:c})}});if(a.success&&a.data.url)e.uploaded=!0,e.url=a.data.url,e.uploading=!1,console.log("Image upload completed:",{index:t,url:a.data.url,totalImages:r.value.length,uploadedCount:r.value.filter(u=>u.uploaded).length}),m("success",{index:t,url:a.data.url,response:a});else throw new Error(a.message||"Erreur lors de l'upload")}catch(s){e.error=!0,e.uploading=!1,d.value.push(`Erreur upload ${e.name}: ${s.message}`),m("error",{index:t,error:s})}j()}},j=()=>{const t=r.value.length,e=r.value.filter(a=>a.uploaded).length,s=r.value.filter(a=>a.uploading).length;t===0?(f.value=0,v.value=!1):s===0?(f.value=100,v.value=!1):(f.value=Math.round(e/t*100),v.value=!0)},W=t=>{const e=r.value[t];e&&e.existing&&m("remove-existing",{index:t,url:e.url}),r.value.splice(t,1)},E=()=>{r.value=[],d.value=[]},q=t=>{const e=r.value[t];e&&(e.error=!0)};return A({uploadAll:()=>{r.value.forEach((t,e)=>{!t.uploaded&&!t.uploading&&S(e)})},clearAll:E,getUploadedUrls:()=>r.value.filter(t=>t.uploaded).map(t=>t.url)}),(t,e)=>(n(),o("div",Z,[l("div",{onDrop:G,onDragover:e[0]||(e[0]=M(()=>{},["prevent"])),onDragenter:[e[1]||(e[1]=M(()=>{},["prevent"])),e[2]||(e[2]=s=>h.value=!0)],class:O(["border-2 border-dashed rounded-xl p-6 text-center transition-all duration-300",h.value?"border-[#0099cc] bg-[#0099cc]/5":"border-gray-300 hover:border-[#0099cc]/50"]),onDragleave:e[3]||(e[3]=s=>h.value=!1)},[l("input",{ref_key:"fileInput",ref:$,type:"file",multiple:"",accept:"image/*",onChange:T,class:"hidden"},null,544),r.value.length?(n(),o("button",{key:1,onClick:z,type:"button",class:"inline-flex items-center px-4 py-2 border-2 border-dashed border-[#0099cc] text-[#0099cc] rounded-lg hover:bg-[#0099cc]/5 transition-colors"},[x(b(J),{class:"w-4 h-4 mr-2"}),e[6]||(e[6]=F(" Ajouter des images ",-1))])):(n(),o("div",{key:0,onClick:z,class:"cursor-pointer"},[x(b(R),{class:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e[4]||(e[4]=l("p",{class:"text-gray-600 font-medium"},"Glissez vos images ici",-1)),e[5]||(e[5]=l("p",{class:"text-sm text-gray-500"},"ou cliquez pour sélectionner",-1)),l("p",ee,y(_.helpText||`JPG, PNG, WebP - Max ${_.maxSizeMB}MB chacune`),1)]))],34),r.value.length?(n(),o("div",te,[l("div",se,[l("h4",ae,y(r.value.length)+" image(s) sélectionnée(s) ",1),l("button",{onClick:E,type:"button",class:"text-xs text-red-600 hover:text-red-700 transition-colors"}," Tout supprimer ")]),l("div",re,[(n(!0),o(B,null,C(r.value,(s,a)=>(n(),o("div",{key:a,class:"relative group"},[l("div",le,[l("img",{src:s.preview,alt:`Image ${a+1}`,class:"w-full h-full object-cover",onError:u=>q(a)},null,40,oe)]),l("div",ne,[l("button",{onClick:u=>W(a),type:"button",class:"bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",title:"Supprimer"},[x(b(V),{class:"w-3 h-3"})],8,ue)]),a===0?(n(),o("div",ie," Principale ")):p("",!0),s.existing?(n(),o("div",de," Existante ")):p("",!0),s.uploading?(n(),o("div",ce,e[7]||(e[7]=[l("div",{class:"bg-white rounded-lg p-2"},[l("div",{class:"w-6 h-6 border-2 border-[#0099cc] border-t-transparent rounded-full animate-spin"})],-1)]))):p("",!0),s.error?(n(),o("div",pe,[l("div",ge,[x(b(H),{class:"w-4 h-4 mx-auto mb-1"}),e[8]||(e[8]=F(" Erreur upload ",-1))])])):p("",!0)]))),128))])])):p("",!0),d.value.length?(n(),o("div",me,[(n(!0),o(B,null,C(d.value,(s,a)=>(n(),o("div",{key:a,class:"text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-2 mb-2"},y(s),1))),128))])):p("",!0),v.value?(n(),o("div",ve,[l("div",fe,[e[9]||(e[9]=l("span",null,"Upload en cours...",-1)),l("span",null,y(f.value)+"%",1)]),l("div",he,[l("div",{class:"bg-[#0099cc] h-2 rounded-full transition-all duration-300",style:K({width:`${f.value}%`})},null,4)])])):p("",!0)]))}},_e=X(xe,[["__scopeId","data-v-eddb71fe"]]);export{_e as I};
