import{r as T,c as M,E as z}from"./vue-core-BXnTE0w7.js";import{a as q}from"./http-NIGUFBhG.js";const $=q.create({baseURL:"https://koumbaya.com/api",headers:{Accept:"application/json"}});$.interceptors.request.use(n=>{const l=localStorage.getItem("auth_token");return l&&(n.headers.Authorization=`Bearer ${l}`),n},n=>Promise.reject(n));$.interceptors.response.use(n=>n,n=>{const l=localStorage.getItem("auth_token");return n.response?.status===401&&!n.config?.url?.includes("/auth/login")&&l&&(localStorage.removeItem("auth_token"),window.router?window.router.push("/login"):window.location.href="/login"),Promise.reject(n)});function j(){const n=T(!1),l=T(null),y=async b=>{n.value=!0,l.value=null;try{return(await b()).data}catch(f){throw l.value=f.response?.data?.message||f.message||"Une erreur est survenue",f}finally{n.value=!1}};return{loading:n,error:l,get:(b,f={})=>y(()=>$.get(b,f)),post:(b,f={},S={})=>{if(f instanceof FormData){const A={...S};return A.headers&&delete A.headers["Content-Type"],y(()=>$.post(b,f,{...A,headers:{...A.headers}}))}const m={...S,headers:{"Content-Type":"application/json",...S.headers}};return y(()=>$.post(b,f,m))},put:(b,f={},S={})=>y(()=>$.put(b,f,S)),delete:(b,f={})=>y(()=>$.delete(b,f)),api:$}}function O(){const{get:n,loading:l,error:y}=j(),w=T({ticketsBought:0,lotteriesParticipated:0,totalSpent:0,prizesWon:0}),r=T([]),i=T([]),p=M(()=>[{label:"Tickets achetés",value:w.value.ticketsBought.toString(),color:"bg-blue-500",icon:"TicketIcon"},{label:"Tombolas participées",value:w.value.lotteriesParticipated.toString(),color:"bg-[#0099cc]",icon:"GiftIcon"},{label:"Total dépensé",value:m(w.value.totalSpent),color:"bg-yellow-500",icon:"CurrencyDollarIcon"},{label:"Prix gagnés",value:w.value.prizesWon.toString(),color:"bg-purple-500",icon:"TrophyIcon"}]),b=async()=>{try{const u=await n("/tickets/my-tickets");if(u&&u.success){const c=Array.isArray(u.data)?u.data:[],t=new Set;let v=0,e=0;c.forEach(o=>{o.lottery_id&&t.add(o.lottery_id),v+=parseFloat(o.amount||0),o.status==="won"&&e++}),w.value={ticketsBought:c.length,lotteriesParticipated:t.size,totalSpent:v,prizesWon:e}}}catch(u){console.error("Erreur lors du chargement des statistiques:",u),w.value={ticketsBought:0,lotteriesParticipated:0,totalSpent:0,prizesWon:0}}},f=async()=>{try{const u=await n("/tickets/my-tickets?limit=5&order=desc");u&&u.success&&Array.isArray(u.data)?r.value=u.data.map(c=>({id:c.id,product:{id:c.product?.id||c.lottery?.product?.id,title:c.product?.name||c.lottery?.product?.name||"Produit inconnu",image:c.product?.image_url||c.lottery?.product?.image_url||"/images/products/placeholder.jpg"},quantity:c.quantity||1,total_price:m(c.amount||0),status:c.status||"active",purchased_at:new Date(c.created_at)})):r.value=[]}catch(u){console.error("Erreur lors du chargement des tickets récents:",u),r.value=[]}},S=async()=>{try{const u=await n("/lotteries/active?limit=6");u&&u.success&&Array.isArray(u.data)?i.value=u.data.map(c=>({id:c.id,product:{id:c.product?.id,title:c.product?.name||"Produit inconnu",price:m(c.product?.price||0),image:c.product?.image_url||c.product?.main_image||"/images/products/placeholder.jpg"},progress:Math.round(c.sold_tickets/c.total_tickets*100)||0,draw_date:new Date(c.end_date)})):i.value=[]}catch(u){console.error("Erreur lors du chargement des tombolas actives:",u),i.value=[]}},m=u=>{const c=parseFloat(u)||0;return c>=1e6?(c/1e6).toFixed(1)+"M FCFA":c>=1e3?(c/1e3).toFixed(0)+"k FCFA":c.toLocaleString()+" FCFA"};return{stats:p,recentTickets:r,activeLotteries:i,loading:l,error:y,loadDashboardData:async()=>{await Promise.all([b(),f(),S()])},loadDashboardStats:b,loadRecentTickets:f,loadActiveLotteries:S,formatCurrency:m,formatDate:u=>new Intl.DateTimeFormat("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}).format(u)}}const B=(n="Image",l=400,y=300,w="#e2e8f0",r="#64748b")=>{const i=Math.min(l,y)/15,p=`
    <svg width="${l}" height="${y}" xmlns="http://www.w3.org/2000/svg">
      <rect width="100%" height="100%" fill="${w}"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" 
            fill="${r}" font-family="Arial, sans-serif" font-size="${i}" font-weight="bold">
        ${n}
      </text>
    </svg>
  `;return`data:image/svg+xml;base64,${btoa(p)}`},G=(n,l="Image non disponible")=>{console.log("Image loading error, using placeholder");const y=n.target,w=y.naturalWidth||y.width||400,r=y.naturalHeight||y.height||300;y.src=B(l,w,r)};function Y(){const{get:n,post:l,loading:y,error:w}=j(),r=T([]),i=T({totalTickets:0,prizesWon:0,totalSpent:0,activeTickets:0}),p=T(1),b=T(!0),f=T(10),S=T(0),m=T({search:"",status:"",period:""}),A=M(()=>{let h=r.value;if(m.value.search){const s=m.value.search.toLowerCase();h=h.filter(g=>g.product.title.toLowerCase().includes(s)||g.product.description.toLowerCase().includes(s))}if(m.value.status&&(h=h.filter(s=>s.status===m.value.status)),m.value.period){const s=new Date,g=m.value.period;h=h.filter(F=>{const k=new Date(F.purchased_at);if(g==="week"){const C=new Date(s.getTime()-6048e5);return k>=C}else if(g==="month"){const C=new Date(s.getFullYear(),s.getMonth()-1,s.getDate());return k>=C}else if(g==="quarter"){const C=new Date(s.getFullYear(),s.getMonth()-3,s.getDate());return k>=C}return!0})}return h.sort((s,g)=>new Date(g.purchased_at)-new Date(s.purchased_at))}),I=M(()=>[{label:"Total tickets",value:i.value.totalTickets.toString(),color:"bg-blue-500",icon:"TicketIcon"},{label:"Prix gagnés",value:i.value.prizesWon.toString(),color:"bg-blue-500",icon:"TrophyIcon"},{label:"Total dépensé",value:_(i.value.totalSpent),color:"bg-yellow-500",icon:"CurrencyDollarIcon"},{label:"En cours",value:i.value.activeTickets.toString(),color:"bg-purple-500",icon:"ClockIcon"}]),u=async(h=1,s=!1)=>{try{const g=new URLSearchParams({page:h.toString(),per_page:f.value.toString()});m.value.search&&g.append("search",m.value.search),m.value.status&&g.append("status",m.value.status),m.value.period&&g.append("period",m.value.period);const F=await n(`/tickets/my-tickets?${g.toString()}`);if(F&&F.success){const k=F.data||[],C=F.pagination||{},P=k.map(D=>({id:D.id,product:{id:D.product?.id||D.lottery?.product?.id,title:D.product?.name||D.lottery?.product?.name||"Produit inconnu",description:D.product?.description||D.lottery?.product?.description||"",image:D.product?.image_url||D.lottery?.product?.image_url||"/images/products/placeholder.jpg"},lottery:{id:D.lottery?.id,draw_date:new Date(D.lottery?.end_date||D.lottery?.draw_date),progress:Math.round(D.lottery?.sold_tickets/D.lottery?.total_tickets*100)||0,winning_number:D.lottery?.winning_number||null},quantity:D.quantity||1,total_price:D.amount||0,status:D.status||"active",purchased_at:new Date(D.created_at),ticket_numbers:D.ticket_numbers||[],winning_number:D.winning_number||null,prize_claimed:D.prize_claimed||!1}));s?r.value=[...r.value,...P]:r.value=P,p.value=C.current_page||h,S.value=C.total||P.length,b.value=C.current_page<C.last_page,v()}}catch(g){console.error("Erreur lors du chargement des tickets:",g)}},c=async()=>{b.value&&!y.value&&await u(p.value+1,!0)},t=async()=>{p.value=1,await u(1,!1)},v=()=>{const h=r.value.length,s=r.value.filter(k=>k.status==="won").length,g=r.value.reduce((k,C)=>{const P=parseFloat(C.total_price)||0;return k+P},0),F=r.value.filter(k=>k.status==="active"||k.status==="pending").length;i.value={totalTickets:h,prizesWon:s,totalSpent:g,activeTickets:F}},e=async h=>{try{const s=await l(`/tickets/${h}/claim-prize`);if(s&&s.success){const g=r.value.findIndex(F=>F.id===h);return g!==-1&&(r.value[g].prize_claimed=!0),s}}catch(s){throw console.error("Erreur lors de la réclamation du prix:",s),s}},o=async h=>{try{const s=await n(`/tickets/${h}/download`);if(s)if(typeof s=="string"&&s.startsWith("http")){const g=document.createElement("a");g.href=s,g.setAttribute("download",`ticket-${h}.pdf`),g.setAttribute("target","_blank"),document.body.appendChild(g),g.click(),g.remove()}else{const g=window.URL.createObjectURL(new Blob([s])),F=document.createElement("a");F.href=g,F.setAttribute("download",`ticket-${h}.pdf`),document.body.appendChild(F),F.click(),F.remove(),window.URL.revokeObjectURL(g)}}catch(s){throw console.error("Erreur lors du téléchargement du ticket:",s),s}},L=()=>{m.value={search:"",status:"",period:""},t()},a=()=>{t()};z(()=>m.value,()=>{clearTimeout(d),d=setTimeout(()=>{a()},500)},{deep:!0});let d=null;const _=h=>{const s=parseFloat(h)||0;return s>=1e6?(s/1e6).toFixed(1)+"M FCFA":s>=1e3?(s/1e3).toFixed(0)+"k FCFA":s.toLocaleString("fr-FR")+" FCFA"};return{tickets:r,filteredTickets:A,stats:I,filters:m,currentPage:p,hasMore:b,total:S,loading:y,error:w,loadTickets:u,loadMore:c,refreshTickets:t,claimPrize:e,downloadTicket:o,resetFilters:L,applyFilters:a,formatCurrency:_,formatDate:h=>new Intl.DateTimeFormat("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(new Date(h)),getRemainingTime:(h,s)=>{if(s==="lost"||s==="won")return"Tirage terminé";const g=new Date,k=new Date(h)-g;if(k<=0)return"Tirage en cours";const C=Math.floor(k/(1e3*60*60*24)),P=Math.floor(k%(1e3*60*60*24)/(1e3*60*60));return C>0?`Tirage dans ${C} jour${C>1?"s":""}`:P>0?`Tirage dans ${P}h`:`Tirage dans ${Math.floor(k%36e5/6e4)}min`},getStatusLabel:h=>({active:"En cours",won:"Gagné",lost:"Perdu",pending:"Tirage imminent"})[h]||h}}function H(){const n=(l,y="info",w=3e3)=>{y==="error"?(console.error(l),alert("Erreur: "+l)):(console.log(l),alert(l))};return{success:l=>n(l,"success"),error:l=>n(l,"error"),info:l=>n(l,"info"),warning:l=>n(l,"warning")}}function N(){const{get:n,loading:l,error:y}=j(),w=T({users:{total:0,active:0,growth:0},products:{total:0,active:0,growth:0},lotteries:{total:0,active:0,growth:0},revenue:{total:0,monthly:0,growth:0}}),r=T([]),i=T([]),p=T([]),b=M(()=>[{label:"Utilisateurs actifs",value:I(w.value.users.active),change:w.value.users.growth,icon:"UsersIcon",bgColor:"bg-[#0099cc]/10",iconColor:"text-[#0099cc]"},{label:"Produits en vente",value:I(w.value.products.active),change:w.value.products.growth,icon:"ShoppingBagIcon",bgColor:"bg-blue-100",iconColor:"text-blue-600"},{label:"Tombolas actives",value:I(w.value.lotteries.active),change:w.value.lotteries.growth,icon:"GiftIcon",bgColor:"bg-yellow-100",iconColor:"text-yellow-600"},{label:"Revenus mensuel",value:u(w.value.revenue.monthly),change:w.value.revenue.growth,icon:"CurrencyDollarIcon",bgColor:"bg-purple-100",iconColor:"text-purple-600"}]),f=async()=>{try{const e=await n("/admin/dashboard/stats");e&&e.success&&(w.value={users:{total:e.data.users?.total||0,active:e.data.users?.active||0,growth:e.data.users?.growth||0},products:{total:e.data.products?.total||0,active:e.data.products?.active||0,growth:e.data.products?.growth||0},lotteries:{total:e.data.lotteries?.total||0,active:e.data.lotteries?.active||0,growth:e.data.lotteries?.growth||0},revenue:{total:e.data.revenue?.total||0,monthly:e.data.revenue?.monthly||0,growth:e.data.revenue?.growth||0}})}catch(e){console.error("Erreur lors du chargement des statistiques:",e),w.value={users:{total:2543,active:1876,growth:12.5},products:{total:186,active:134,growth:8.2},lotteries:{total:45,active:24,growth:-2.1},revenue:{total:125e6,monthly:452e5,growth:15.3}}}},S=async()=>{try{const e=await n("/admin/lotteries/recent?limit=5");e&&e.success&&(r.value=e.data.map(o=>({id:o.id,lottery_number:o.lottery_number,product:{name:o.product?.name||"Produit inconnu",image:o.product?.image_url||o.product?.main_image||"/images/products/placeholder.jpg"},status:o.status,statusLabel:c(o.status),sold_tickets:o.sold_tickets||0,total_tickets:o.total_tickets||0,end_date:o.end_date})))}catch(e){console.error("Erreur lors du chargement des tombolas récentes:",e),r.value=[]}},m=async()=>{try{const e=await n("/admin/activities/recent?limit=10");e&&e.success&&(i.value=e.data.map(o=>({id:o.id,type:o.type,icon:t(o.type),title:o.title,description:o.description,time:new Date(o.created_at)})))}catch(e){console.error("Erreur lors du chargement des activités récentes:",e),i.value=[]}},A=async()=>{try{const e=await n("/admin/products/top?limit=5");e&&e.success&&(p.value=e.data.map(o=>({id:o.id,title:o.name,sales:o.total_tickets_sold||0,growth:o.growth_percentage||0,image:o.image_url||o.main_image||"/images/products/placeholder.jpg"})))}catch(e){console.error("Erreur lors du chargement des produits populaires:",e),p.value=[]}},I=e=>e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"k":e.toLocaleString(),u=e=>e>=1e6?(e/1e6).toFixed(1)+"M FCFA":e>=1e3?(e/1e3).toFixed(0)+"k FCFA":e.toLocaleString()+" FCFA",c=e=>({active:"Active",completed:"Terminée",pending:"En attente",cancelled:"Annulée",draft:"Brouillon"})[e]||e,t=e=>({user:"UsersIcon",product:"ShoppingBagIcon",payment:"CurrencyDollarIcon",lottery:"GiftIcon",transaction:"BanknotesIcon"})[e]||"InformationCircleIcon";return{stats:b,recentLotteries:r,recentActivities:i,topProducts:p,loading:l,error:y,loadDashboardData:async()=>{await Promise.all([f(),S(),m(),A()])},loadDashboardStats:f,loadRecentLotteries:S,loadRecentActivities:m,loadTopProducts:A,formatNumber:I,formatCurrency:u,getStatusLabel:c,getActivityIcon:t}}function J(){const{get:n,put:l,loading:y,error:w}=j(),r=T([]),i=T({total_orders:0,revenue:0,pending:0,conversion_rate:0}),p=T([]),b=async()=>{try{const t=await n("/merchant/dashboard/stats");return t&&t.data&&(i.value={total_orders:parseInt(t.data.tickets_sold||0),revenue:parseFloat(t.data.total_sales||0),pending:parseInt(t.data.pending_orders||0),conversion_rate:parseFloat(t.data.conversion_rate||0)}),t}catch(t){throw console.error("Erreur lors du chargement des stats:",t),i.value={total_orders:0,revenue:0,pending:0,conversion_rate:0},t}},f=async(t={})=>{try{const v=new URLSearchParams;t.search&&v.append("search",t.search),t.status&&v.append("status",t.status),t.product&&v.append("product_id",t.product),t.startDate&&v.append("start_date",t.startDate),t.endDate&&v.append("end_date",t.endDate),t.limit&&v.append("limit",t.limit);const e=v.toString(),o=`/merchant/dashboard/recent-transactions${e?"?"+e:""}`,L=await n(o);return L&&L.data&&Array.isArray(L.data)?r.value=L.data.map(a=>({id:a.id||Math.random(),order_number:a.transaction_id||`ORD-${a.id}`,customer_name:a.user?.name||"Client inconnu",customer_email:a.user?.email||"",product_name:a.product?.title||"Produit inconnu",product_image:a.product?.image_url||"/images/products/placeholder.jpg",tickets_count:parseInt(a.quantity||0),ticket_numbers:a.ticket_numbers||[],ticket_price:parseFloat(a.amount||0)/Math.max(parseInt(a.quantity||1),1),total_amount:parseFloat(a.amount||0),currency:"FCFA",payment_method:a.payment_method||"Mobile Money",status:a.status||"completed",created_at:a.completed_at||a.created_at})):r.value=[],L}catch(v){throw console.error("Erreur lors du chargement des commandes:",v),r.value=[],v}},S=async()=>{try{const t=await n("/merchant/dashboard/top-products?limit=100");return t&&t.data&&Array.isArray(t.data)?p.value=t.data.map(v=>({id:v.id,name:v.title||v.name||"Produit sans nom"})):p.value=[],t}catch(t){throw console.error("Erreur lors du chargement des produits:",t),p.value=[],t}},m=async(t,v)=>{try{const e=await l(`/transactions/${t}/status`,{status:v});if(e.success){const o=r.value.findIndex(L=>L.id===t);o!==-1&&(r.value[o].status=v)}return e}catch(e){throw console.error("Erreur lors de la mise à jour du statut:",e),e}},A=async t=>m(t.id,"confirmed"),I=async t=>m(t.id,"cancelled"),u=async(t="csv")=>{try{return await n(`/merchant/dashboard/export-orders?format=${t}`)}catch(v){throw console.error("Erreur lors de l'export:",v),v}},c=M(()=>{const t=new Date,v=new Date(t.getTime()-10080*60*1e3);r.value.filter(o=>new Date(o.created_at)>=v);const e=o=>0;return[{label:"Total commandes",value:(i.value.total_orders||0).toString(),change:e(i.value.total_orders),icon:"ShoppingBagIcon",color:"bg-[#0099cc]"},{label:"Revenus",value:Math.floor(i.value.revenue||0).toLocaleString(),change:e(i.value.revenue),icon:"CurrencyDollarIcon",color:"bg-blue-500"},{label:"En attente",value:(i.value.pending||0).toString(),change:e(i.value.pending),icon:"ClockIcon",color:"bg-yellow-500"},{label:"Taux conversion",value:`${i.value.conversion_rate||0}%`,change:e(i.value.conversion_rate),icon:"CheckIcon",color:"bg-purple-500"}]});return{orders:r,stats:i,products:p,orderStats:c,loading:y,error:w,loadStats:b,loadOrders:f,loadProducts:S,updateOrderStatus:m,confirmOrder:A,cancelOrder:I,exportOrders:u}}function K(){const{get:n,post:l,loading:y,error:w}=j(),r=T([]),i=T({total:0,active:0,completed:0,pending:0,cancelled:0}),p=T({status:"all",search:"",sortBy:"end_date_asc"}),b=T({current_page:1,per_page:15,total:0,last_page:1}),f=async(a={})=>{try{const d={per_page:p.value.per_page||15,page:a.page||1,sort_by:p.value.sortBy,...a};p.value.status&&p.value.status!=="all"&&(d.status=p.value.status),p.value.search&&(d.search=p.value.search);const _=await n("/merchant/dashboard/lottery-performance",{params:d});return _.success&&(r.value=_.data.data||_.data,_.data.current_page&&(b.value={current_page:_.data.current_page,per_page:_.data.per_page,total:_.data.total,last_page:_.data.last_page}),_.stats?i.value=_.stats:S()),_}catch(d){throw console.error("Erreur lors du chargement des tombolas:",d),d}},S=()=>{const a=r.value.length,d=r.value.filter(x=>x.status==="active").length,_=r.value.filter(x=>x.status==="completed").length,E=r.value.filter(x=>x.status==="pending").length,R=r.value.filter(x=>x.status==="cancelled").length;i.value={total:a,active:d,completed:_,pending:E,cancelled:R}},m=async a=>{try{const d=await l(`/lotteries/${a}/draw`);if(d.success||d.message){const _=r.value.findIndex(E=>E.id===a);_!==-1&&(r.value[_]={...r.value[_],status:"completed",is_drawn:!0,winner_user_id:d.lottery?.winner_user_id,winner_ticket_number:d.lottery?.winner_ticket_number,draw_date:d.lottery?.draw_date}),S()}return d}catch(d){throw console.error("Erreur lors du tirage:",d),d}},A=async a=>{try{const d=await n(`/lotteries/${a}`);return d.lottery||d.data}catch(d){throw console.error("Erreur lors du chargement des détails:",d),d}},I=async a=>{p.value={...p.value,...a},await f()},u=async a=>{p.value.search=a,await f()},c=async a=>{await f({page:a})},t=M(()=>[{key:"all",label:"Toutes",count:i.value.total},{key:"active",label:"Actives",count:i.value.active},{key:"pending",label:"En attente",count:i.value.pending},{key:"completed",label:"Terminées",count:i.value.completed},{key:"cancelled",label:"Annulées",count:i.value.cancelled}]);return{lotteries:M(()=>{let a=[...r.value];if(p.value.search){const d=p.value.search.toLowerCase();a=a.filter(_=>_.lottery_number?.toLowerCase().includes(d)||_.product?.name?.toLowerCase().includes(d)||_.product?.description?.toLowerCase().includes(d))}return a}),stats:i,filters:p,pagination:b,tabs:t,loading:y,error:w,fetchLotteries:f,drawLottery:m,getLotteryDetails:A,updateFilters:I,searchLotteries:u,changePage:c,canDrawLottery:a=>a.status==="active"&&!a.is_drawn&&a.can_draw===!0&&new Date(a.end_date)<=new Date,getFormattedStatus:a=>({pending:{label:"En attente",class:"bg-yellow-100 text-yellow-800"},active:{label:"Active",class:"bg-green-100 text-green-800"},completed:{label:"Terminée",class:"bg-blue-100 text-blue-800"},cancelled:{label:"Annulée",class:"bg-red-100 text-red-800"}})[a]||{label:a,class:"bg-gray-100 text-gray-800"},getTimeRemaining:a=>{const d=new Date,E=new Date(a)-d;if(E<=0)return"Terminée";const R=Math.floor(E/(1e3*60*60*24)),x=Math.floor(E%(1e3*60*60*24)/(1e3*60*60)),h=Math.floor(E%(1e3*60*60)/(1e3*60));return R>0?`${R}j ${x}h`:x>0?`${x}h ${h}min`:`${h}min`}}}export{$ as a,N as b,O as c,Y as d,H as e,J as f,K as g,G as h,j as u};
