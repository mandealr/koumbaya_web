import{r as p,c as G,R as w,b as o,e as l,l as d,g as x,u as h,a$ as R,t as y,i as S,av as W,y as q,z as U,F as A,A as B,x as L,v as J,a7 as O,o as n}from"./vendor-CS2FKTs1.js";import{_ as H,a as K}from"./app-S-rVv70c.js";const Q={class:"image-upload-container"},X={class:"text-xs text-gray-400 mt-2"},Y={key:0,class:"mt-4"},Z={class:"flex items-center justify-between mb-3"},ee={class:"text-sm font-medium text-gray-700"},te={class:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"},se={class:"aspect-square rounded-lg overflow-hidden border border-gray-200"},ae=["src","alt","onError"],re={class:"absolute top-1 right-1 flex space-x-1"},le=["onClick"],oe={key:0,class:"absolute bottom-1 left-1 bg-[#0099cc] text-white text-xs px-2 py-1 rounded"},ne={key:1,class:"absolute top-1 left-1 bg-green-500 text-white text-xs px-2 py-1 rounded",title:"Image existante"},ue={key:2,class:"absolute inset-0 bg-black/50 flex items-center justify-center rounded-lg"},ie={key:3,class:"absolute inset-0 bg-red-500/80 flex items-center justify-center rounded-lg"},de={class:"text-white text-xs text-center p-2"},ce={key:1,class:"mt-3"},pe={key:2,class:"mt-4"},me={class:"flex items-center justify-between text-sm text-gray-600 mb-1"},ge={class:"w-full bg-gray-200 rounded-full h-2"},ve={__name:"ImageUpload",props:{modelValue:{type:Array,default:()=>[]},uploadEndpoint:{type:String,default:"/products/images"},maxFiles:{type:Number,default:10},maxSizeMB:{type:Number,default:5},helpText:{type:String,default:null},autoUpload:{type:Boolean,default:!0},existingImages:{type:Array,default:()=>[]}},emits:["update:modelValue","success","error","progress","remove-existing"],setup(b,{expose:E,emit:F}){const u=b,m=F,{post:C}=K(),k=p(null),r=p([]),i=p([]),f=p(!1),g=p(!1),v=p(0),_=G(()=>u.maxFiles-r.value.length);w(()=>u.modelValue,t=>{t&&t.length>0&&(r.value=t.map(e=>({preview:e,url:e,uploaded:!0})))},{immediate:!0}),w(()=>u.existingImages,t=>{if(t&&t.length>0){const e=t.map(a=>({preview:a,url:a,uploaded:!0,existing:!0})),s=r.value.filter(a=>!a.existing);r.value=[...e,...s]}},{immediate:!0}),w(r,t=>{const e=t.filter(s=>s.uploaded&&s.url).map(s=>s.url);m("update:modelValue",e)},{deep:!0});const $=()=>{k.value?.click()},j=t=>{const e=Array.from(t.target.files);I(e),t.target.value=""},N=t=>{t.preventDefault(),f.value=!1;const e=Array.from(t.dataTransfer.files).filter(s=>s.type.startsWith("image/"));I(e)},I=t=>{i.value=[],t.length>_.value&&(i.value.push(`Maximum ${u.maxFiles} images autorisées. ${_.value} emplacements restants.`),t=t.slice(0,_.value)),t.forEach(e=>{if(e.size>u.maxSizeMB*1024*1024){i.value.push(`${e.name} est trop volumineux (max ${u.maxSizeMB}MB)`);return}if(!e.type.startsWith("image/")){i.value.push(`${e.name} n'est pas une image valide`);return}const s=new FileReader;s.onload=a=>{const c={file:e,preview:a.target.result,name:e.name,size:e.size,uploading:!1,uploaded:!1,error:!1,url:null};r.value.push(c),u.autoUpload&&D(r.value.length-1)},s.readAsDataURL(e)})},D=async t=>{const e=r.value[t];if(!(!e||e.uploaded||e.uploading)){e.uploading=!0,e.error=!1,g.value=!0;try{const s=new FormData;s.append("image",e.file),s.append("index",t);const a=await C(u.uploadEndpoint,s,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:c=>{const V=Math.round(c.loaded*100/c.total);z(),m("progress",{index:t,progress:V})}});if(a.success&&a.data.url)e.uploaded=!0,e.url=a.data.url,e.uploading=!1,m("success",{index:t,url:a.data.url,response:a});else throw new Error(a.message||"Erreur lors de l'upload")}catch(s){e.error=!0,e.uploading=!1,i.value.push(`Erreur upload ${e.name}: ${s.message}`),m("error",{index:t,error:s})}z()}},z=()=>{const t=r.value.length,e=r.value.filter(a=>a.uploaded).length,s=r.value.filter(a=>a.uploading).length;t===0?(v.value=0,g.value=!1):s===0?(v.value=100,g.value=!1):(v.value=Math.round(e/t*100),g.value=!0)},P=t=>{const e=r.value[t];e&&e.existing&&m("remove-existing",{index:t,url:e.url}),r.value.splice(t,1)},M=()=>{r.value=[],i.value=[]},T=t=>{const e=r.value[t];e&&(e.error=!0)};return E({uploadAll:()=>{r.value.forEach((t,e)=>{!t.uploaded&&!t.uploading&&D(e)})},clearAll:M,getUploadedUrls:()=>r.value.filter(t=>t.uploaded).map(t=>t.url)}),(t,e)=>(n(),o("div",Q,[l("div",{onDrop:N,onDragover:e[0]||(e[0]=U(()=>{},["prevent"])),onDragenter:[e[1]||(e[1]=U(()=>{},["prevent"])),e[2]||(e[2]=s=>f.value=!0)],class:q(["border-2 border-dashed rounded-xl p-6 text-center transition-all duration-300",f.value?"border-[#0099cc] bg-[#0099cc]/5":"border-gray-300 hover:border-[#0099cc]/50"]),onDragleave:e[3]||(e[3]=s=>f.value=!1)},[l("input",{ref_key:"fileInput",ref:k,type:"file",multiple:"",accept:"image/*",onChange:j,class:"hidden"},null,544),r.value.length?(n(),o("button",{key:1,onClick:$,type:"button",class:"inline-flex items-center px-4 py-2 border-2 border-dashed border-[#0099cc] text-[#0099cc] rounded-lg hover:bg-[#0099cc]/5 transition-colors"},[x(h(W),{class:"w-4 h-4 mr-2"}),e[6]||(e[6]=S(" Ajouter des images ",-1))])):(n(),o("div",{key:0,onClick:$,class:"cursor-pointer"},[x(h(R),{class:"w-12 h-12 text-gray-400 mx-auto mb-2"}),e[4]||(e[4]=l("p",{class:"text-gray-600 font-medium"},"Glissez vos images ici",-1)),e[5]||(e[5]=l("p",{class:"text-sm text-gray-500"},"ou cliquez pour sélectionner",-1)),l("p",X,y(b.helpText||`JPG, PNG, WebP - Max ${b.maxSizeMB}MB chacune`),1)]))],34),r.value.length?(n(),o("div",Y,[l("div",Z,[l("h4",ee,y(r.value.length)+" image(s) sélectionnée(s) ",1),l("button",{onClick:M,type:"button",class:"text-xs text-red-600 hover:text-red-700 transition-colors"}," Tout supprimer ")]),l("div",te,[(n(!0),o(A,null,B(r.value,(s,a)=>(n(),o("div",{key:a,class:"relative group"},[l("div",se,[l("img",{src:s.preview,alt:`Image ${a+1}`,class:"w-full h-full object-cover",onError:c=>T(a)},null,40,ae)]),l("div",re,[l("button",{onClick:c=>P(a),type:"button",class:"bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600",title:"Supprimer"},[x(h(L),{class:"w-3 h-3"})],8,le)]),a===0?(n(),o("div",oe," Principale ")):d("",!0),s.existing?(n(),o("div",ne," Existante ")):d("",!0),s.uploading?(n(),o("div",ue,e[7]||(e[7]=[l("div",{class:"bg-white rounded-lg p-2"},[l("div",{class:"w-6 h-6 border-2 border-[#0099cc] border-t-transparent rounded-full animate-spin"})],-1)]))):d("",!0),s.error?(n(),o("div",ie,[l("div",de,[x(h(J),{class:"w-4 h-4 mx-auto mb-1"}),e[8]||(e[8]=S(" Erreur upload ",-1))])])):d("",!0)]))),128))])])):d("",!0),i.value.length?(n(),o("div",ce,[(n(!0),o(A,null,B(i.value,(s,a)=>(n(),o("div",{key:a,class:"text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-2 mb-2"},y(s),1))),128))])):d("",!0),g.value?(n(),o("div",pe,[l("div",me,[e[9]||(e[9]=l("span",null,"Upload en cours...",-1)),l("span",null,y(v.value)+"%",1)]),l("div",ge,[l("div",{class:"bg-[#0099cc] h-2 rounded-full transition-all duration-300",style:O({width:`${v.value}%`})},null,4)])])):d("",!0)]))}},he=H(ve,[["__scopeId","data-v-1a22a97e"]]);export{he as I};
